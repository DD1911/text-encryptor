<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sichere Text-Verschl√ºsselung ‚Äì AES & Decrypt</title>
    
    <style>
        /* Grund-Layout + Farben f√ºr ein modernes UI */
        body {
            background: #f2f5f7;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 30px;
            min-height: 100vh;
        }

        /* Wrapper damit beide Panels nebeneinander erscheinen */
        .panels-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
        }

        /* Panel Card Style f√ºr Verschl√ºsseln / Entschl√ºsseln */
        .panel {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            background: white;
            padding: 25px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Info-Panel unterhalb (AES-GCM Details) */
        .info-panel {
            width: 100%;
            max-width: 920px;
            background: #eef6ee;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            color: #222;
        }

        h2 { text-align:center; color:#2e8b57; margin-top:0; }
        label { display:block; margin-top:10px; font-weight:600; color:#333; }
        
        /* Eingabefelder f√ºr Text */
        textarea { 
            width:100%; 
            height:80px; 
            font-family: 'Courier New', monospace; 
            font-size:14px; 
            padding:10px; 
            border-radius:8px; 
            border:1px solid #ccc; 
            resize:vertical; 
            box-sizing: border-box;
        }

        /* Passwort-Feld Styling */
        input[type="password"] { 
            width:100%; 
            padding:10px; 
            border-radius:6px; 
            border:1px solid #ccc; 
            margin-top:5px; 
            box-sizing: border-box;
        }
        
        /* Buttons f√ºrs UI */
        button { 
            margin-top:15px; 
            padding:12px; 
            border-radius:8px; 
            border:none; 
            background:#2e8b57;
            color:white; 
            cursor:pointer; 
            width:100%; 
            font-weight:600; 
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover { background: #257a4a; }

        /* Ausgabe-Feld (Verschl√ºsseltes Ergebnis / Plaintext) */
        .output { 
            margin-top:15px; 
            background:#e8f0fe;
            padding:10px; 
            border-radius:8px; 
            font-family: monospace; 
            font-size: 0.9em;
            min-height:40px; 
            display:flex; 
            align-items:center; 
            justify-content:space-between; 
            word-break:break-all;
        }
        
        /* Kleiner Button zum Kopieren */
        .copy-btn { 
            width: auto; 
            margin-top: 0; 
            background:#ddd; 
            color:#333; 
            padding: 5px 10px;
        }
        .copy-btn:hover { background: #ccc; }
    </style>
</head>
<body>

<div class="panels-wrapper">

    <!-- Panel links zum Verschl√ºsseln -->
    <div class="panel" id="encryptPanel">
        <h2>üîê Verschl√ºsseln</h2>

        <!-- Passwort wird zur Schl√ºssel-Ableitung genutzt -->
        <label for="encPassword">1. Passwort w√§hlen</label>
        <input type="password" id="encPassword" placeholder="Sicheres Passwort eingeben">

        <!-- Text der sp√§ter per AES-GCM verschl√ºsselt wird -->
        <label for="plainText">2. Nachricht eingeben</label>
        <textarea id="plainText" placeholder="Geheimer Text..."></textarea>

        <button id="encryptBtn">Verschl√ºsseln</button>

        <!-- AES-GCM liefert Chiffre + IV (Initialisierungsvektor) -->
        <label>Ergebnis</label>
        <div class="output">
            <span id="encryptedOutput">...</span>
            <!-- Button zum schnellen Kopieren -->
            <button class="copy-btn" id="copyEnc" title="Kopieren">üìã</button>
        </div>
    </div>

    <!-- Panel rechts zum Entschl√ºsseln -->
    <div class="panel" id="decryptPanel">
        <h2>üîì Entschl√ºsseln</h2>

        <!-- Gleiches Passwort notwendig, sonst Validierungsschritt scheitert -->
        <label for="decPassword">1. Passwort eingeben</label>
        <input type="password" id="decPassword" placeholder="Das gleiche Passwort wie links">

        <!-- Erwartet wird der String "Cipher::IV" -->
        <label for="cipherText">2. Verschl√ºsselten Code einf√ºgen</label>
        <textarea id="cipherText" placeholder="String hier einf√ºgen (Format: Chiffre::IV)"></textarea>

        <button id="decryptBtn">Entschl√ºsseln</button>

        <!-- Ausgabe wird im Erfolgsfall Klartext -->
        <label>Entschl√ºsselter Klartext</label>
        <div class="output">
            <span id="decryptedOutput">...</span>
            <button class="copy-btn" id="copyDec" title="Kopieren">üìã</button>
        </div>
    </div>
</div>

<script>
    // Salt f√ºr PBKDF2 (hier fix, f√ºr echte Produktion randomisiert + gespeichert)
    const FIXED_SALT = "projekt_salt_v1"; 

    // ArrayBuffer -> Base64, n√∂tig f√ºr Textdarstellung
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]); // Byte f√ºr Byte in String wandeln
        }
        return window.btoa(binary); // Base64 repr√§sentiert dann die bin√§ren Daten
    }

    // Base64 -> ArrayBuffer, um decrypt/crypto wieder nutzen zu k√∂nnen
    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i); // zur√ºck in Bytes
        }
        return bytes.buffer;
    }

    // Schl√ºssel aus Passwort ableiten (PBKDF2 + SHA-256 ‚Üí AES-256)
    async function deriveKeyFromPassword(password, salt, usage) {
        const enc = new TextEncoder();
        
        // Passwort importieren als Crypto KeyMaterial
        const keyMaterial = await crypto.subtle.importKey(
            "raw", 
            enc.encode(password), 
            "PBKDF2", 
            false, 
            ["deriveKey"]
        );

        // Ableiten des AES-Schl√ºssels (Iteration sch√ºtzt gegen Brute-Force)
        return await crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: enc.encode(salt),
                iterations: 100000, // relativ hoch f√ºr besseren Schutz
                hash: "SHA-256"
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            true,
            [usage]
        );
    }

    // AES-GCM Verschl√ºsselung von Text
    async function encryptText(plainText, password) {
        const enc = new TextEncoder();
        
        // Key aus Passwort erstellen
        const key = await deriveKeyFromPassword(password, FIXED_SALT, "encrypt");
        
        // IV: wichtig f√ºr GCM, muss zuf√§llig sein
        const iv = crypto.getRandomValues(new Uint8Array(12));

        // Verschl√ºsseln, liefert Chiffre + Auth-Tag
        const cipherBuffer = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            enc.encode(plainText)
        );

        // R√ºckgabe im Base64 Format
        return {
            cipher: arrayBufferToBase64(cipherBuffer),
            iv: arrayBufferToBase64(iv)
        };
    }

    // AES-GCM Entschl√ºsselung (Validierung durch Auth-Tag)
    async function decryptText(cipherBase64, ivBase64, password) {
        const dec = new TextDecoder();

        // Key wieder aus Passwort ableiten
        const key = await deriveKeyFromPassword(password, FIXED_SALT, "decrypt");

        const cipherBuffer = base64ToArrayBuffer(cipherBase64);
        const ivBuffer = base64ToArrayBuffer(ivBase64);

        // Wenn Tag ung√ºltig ‚Üí Passwort falsch oder Daten manipuliert
        const plainBuffer = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv: ivBuffer },
            key,
            cipherBuffer
        );

        return dec.decode(plainBuffer);
    }

    // Event Listener: Verschl√ºsseln Button
    const encryptBtn = document.getElementById("encryptBtn");
    const decryptBtn = document.getElementById("decryptBtn");
    
    encryptBtn.onclick = async () => {
        const pwd = document.getElementById("encPassword").value;
        const text = document.getElementById("plainText").value;

        // einfache Validierung im UI
        if(!pwd || !text) {
            alert("Bitte Passwort und Text eingeben.");
            return;
        }

        try {
            const result = await encryptText(text, pwd);
            // Eigenes Format: Cipher::IV, zum leichteren Kopieren/Teilen
            const outputString = `${result.cipher}::${result.iv}`;
            document.getElementById("encryptedOutput").textContent = outputString;
        } catch (err) {
            console.error("Fehler im Verschl√ºsselungsprozess:", err);
            alert("Fehler bei der Verschl√ºsselung.");
        }
    };

    // Event Listener: Entschl√ºsseln Button
    decryptBtn.onclick = async () => {
        const pwd = document.getElementById("decPassword").value;
        const fullCipherString = document.getElementById("cipherText").value;

        if(!pwd || !fullCipherString) {
            alert("Bitte alle Felder ausf√ºllen.");
            return;
        }

        // Pr√ºfen ob "::" vorhanden ist
        if(!fullCipherString.includes("::")) {
            alert("Ung√ºltiges Format! Erwartet wird 'Cipher::IV'.");
            return;
        }

        try {
            const parts = fullCipherString.split("::");
            const cipherPart = parts[0];
            const ivPart = parts[1];

            const plainText = await decryptText(cipherPart, ivPart, pwd);
            document.getElementById("decryptedOutput").textContent = plainText;
        } catch (err) {
            console.error("Entschl√ºsselung fehlgeschlagen:", err);
            alert("Fehler! Passwort falsch oder Daten manipuliert.");
            document.getElementById("decryptedOutput").textContent = "FEHLER";
        }
    };

    // Copy-Funktion f√ºrs UI (Clipboard API)
    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        if(text && text !== "..." && text !== "FEHLER") {
            navigator.clipboard.writeText(text).then(() => {
                alert("In Zwischenablage kopiert!");
            });
        }
    }

    // Copy Buttons verbinden
    document.getElementById("copyEnc").onclick = () => copyToClipboard("encryptedOutput");
    document.getElementById("copyDec").onclick = () => copyToClipboard("decryptedOutput");

</script>
</body>
</html>


